<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario - Papelería</title>
  <style>
    :root{
      --main-bg: #f7f7fb;
      --accent: #2b6cb0;
      --text-color: #0f172a;
      --font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      --font-size: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font-family);font-size:var(--font-size);background:var(--main-bg);color:var(--text-color)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.2));box-shadow:0 1px 6px rgba(0,0,0,0.06)}
    header h1{margin:0;font-size:1.1rem}
    .wrap{display:grid;grid-template-columns:1fr 360px;gap:18px;padding:18px;max-width:1200px;margin:18px auto}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}

    /* public products */
    #publicList{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .product{border-radius:10px;overflow:hidden;border:1px solid #eef2ff;background:#fff}
    .product img{width:100%;height:140px;object-fit:cover;display:block}
    .product .info{padding:8px}
    .product .name{font-weight:600;margin-bottom:6px}
    .product .price{font-weight:700}
    .product .qty{font-size:0.9rem;color:#666}

    /* owner panel */
    #ownerPanel{display:flex;flex-direction:column;gap:12px}
    label{display:block;font-size:0.85rem;margin-bottom:6px}
    input[type=text],input[type=number],input[type=file],select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3}
    button{cursor:pointer;padding:8px 10px;border-radius:8px;border:0}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #e6edf3}
    .small{padding:6px 8px;font-size:0.9rem}
    .row{display:flex;gap:8px}
    .flex{flex:1}
    footer{padding:12px;text-align:center;color:#475569;font-size:0.85rem}

    /* responsive */
    @media(max-width:900px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Inventario - Papelería</h1>
    <div>
      <button id="ownerBtn" class="small">Panel del dueño</button>
      <button id="logoutBtn" class="small" style="display:none">Salir</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2 style="margin-top:0">Productos</h2>
      <div id="publicList">Cargando...</div>
    </section>

    <aside class="card" id="ownerCard">
      <div id="ownerLocked">
        <p>Acceso restringido. Ingresa la contraseña del dueño para modificar el inventario y estilos.</p>
        <input id="ownerPass" type="password" placeholder="Contraseña del dueño" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loginOwner" class="btn-primary">Entrar</button>
          <button id="cancelLogin" class="btn-ghost">Cancelar</button>
        </div>
      </div>

      <div id="ownerPanel" style="display:none">
        <h3>Administrar productos</h3>
        <label>Nombre</label>
        <input id="prodName" type="text" placeholder="Nombre del producto" />
        <label>Precio</label>
        <input id="prodPrice" type="number" min="0" step="0.01" placeholder="Precio" />
        <label>Cantidad</label>
        <input id="prodQty" type="number" min="0" step="1" placeholder="Cantidad" />
        <label>Imagen</label>
        <input id="prodImage" type="file" accept="image/*" />
        <div style="display:flex;gap:8px">
          <button id="saveProd" class="btn-primary">Guardar producto</button>
          <button id="clearForm" class="btn-ghost">Limpiar</button>
        </div>

        <hr />
        <h3>Estilos globales</h3>
        <label>Color de fondo</label>
        <input id="styleBg" type="text" placeholder="#f7f7fb o nombre" />
        <label>Color del acento</label>
        <input id="styleAccent" type="text" placeholder="#2b6cb0" />
        <label>Tipografía (font-family)</label>
        <input id="styleFont" type="text" placeholder="'Arial', sans-serif" />
        <label>Tamaño base (px)</label>
        <input id="styleSize" type="number" min="12" max="24" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="saveStyles" class="btn-primary">Guardar estilos</button>
          <button id="resetStyles" class="btn-ghost">Restablecer</button>
        </div>

        <hr />
        <h3>Productos (editar / eliminar)</h3>
        <div id="ownerProducts">Cargando...</div>
      </div>
    </aside>
  </main>

  <footer>
    Esta aplicación guarda los cambios en Firebase (Firestore + Storage). Reemplaza <code>firebaseConfig</code> con tu configuración antes de usar.
  </footer>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // ------------------------- CONFIGURACIÓN -------------------------
    // Reemplaza este objecto con tu firebaseConfig (obtenido de la consola de Firebase)
const firebaseConfig = {
  apiKey: "AIzaSyAiyYFIN0drkgr5t44H5_ton1pvJZ3ZfVY",
  authDomain: "inventario-jgs.firebaseapp.com",
  projectId: "inventario-jgs",
  storageBucket: "inventario-jgs.firebasestorage.app",
  messagingSenderId: "996017365401",
  appId: "1:996017365401:web:80a5ed2d92adf80fd7f308",
  measurementId: "G-3HY7TVPJ80"
};
    
    // -----------------------------------------------------------------
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // colecciones y doc de configuración
    const PRODUCTS = 'products';
    const META_COLLECTION = 'meta';
    const SETTINGS_DOC = 'settings';

    // UI refs
    const publicList = document.getElementById('publicList');
    const ownerBtn = document.getElementById('ownerBtn');
    const ownerCard = document.getElementById('ownerCard');
    const ownerLocked = document.getElementById('ownerLocked');
    const ownerPanel = document.getElementById('ownerPanel');
    const ownerProducts = document.getElementById('ownerProducts');
    const loginOwner = document.getElementById('loginOwner');
    const ownerPass = document.getElementById('ownerPass');
    const logoutBtn = document.getElementById('logoutBtn');

    const prodName = document.getElementById('prodName');
    const prodPrice = document.getElementById('prodPrice');
    const prodQty = document.getElementById('prodQty');
    const prodImage = document.getElementById('prodImage');
    const saveProd = document.getElementById('saveProd');
    const clearForm = document.getElementById('clearForm');

    const styleBg = document.getElementById('styleBg');
    const styleAccent = document.getElementById('styleAccent');
    const styleFont = document.getElementById('styleFont');
    const styleSize = document.getElementById('styleSize');
    const saveStyles = document.getElementById('saveStyles');
    const resetStyles = document.getElementById('resetStyles');

    let currentEditId = null; // si se está editando
    let ownerLogged = false;

    // ---------- helpers ----------
    async function sha256(str){
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', data);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function applyStyles(settings){
      if(!settings) return;
      if(settings.bg) document.documentElement.style.setProperty('--main-bg', settings.bg);
      if(settings.accent) document.documentElement.style.setProperty('--accent', settings.accent);
      if(settings.font) document.documentElement.style.setProperty('--font-family', settings.font);
      if(settings.size) document.documentElement.style.setProperty('--font-size', settings.size + 'px');

      // fill inputs for owner panel
      styleBg.value = settings.bg || '';
      styleAccent.value = settings.accent || '';
      styleFont.value = settings.font || '';
      styleSize.value = settings.size || '';
    }

    // ---------- carga en tiempo real ----------
    function initRealtime(){
      db.collection(META_COLLECTION).doc(SETTINGS_DOC).onSnapshot(doc=>{
        const data = doc.exists ? doc.data() : {};
        applyStyles(data);
      });

      db.collection(PRODUCTS).orderBy('createdAt','desc').onSnapshot(snapshot=>{
        const items = [];
        snapshot.forEach(doc=>items.push({id:doc.id,...doc.data()}));
        renderPublic(items);
        if(ownerLogged) renderOwnerList(items);
      });
    }

    // ---------- render publico ----------
    function renderPublic(items){
      if(items.length===0){ publicList.innerHTML = '<p>No hay productos.</p>'; return }
      publicList.innerHTML = items.map(it=>`
        <div class="product">
          <img src="${it.imageURL||'data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'200\'><rect width=\'100%\' height=\'100%\' fill=\'%23e2e8f0\'/> <text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%236b7280\' font-size=\'20\'>Sin imagen</text></svg>'}" alt="${escapeHtml(it.name)}"/>
          <div class="info">
            <div class="name">${escapeHtml(it.name)}</div>
            <div class="price">$ ${Number(it.price).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
            <div class="qty">Disponibles: ${Number(it.qty)}</div>
          </div>
        </div>
      `).join('');
    }

    // ---------- render owner list ----------
    function renderOwnerList(items){
      if(items.length===0){ ownerProducts.innerHTML = '<p>No hay productos.</p>'; return }
      ownerProducts.innerHTML = items.map(it=>`
        <div style="display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;border:1px solid #f0f6ff;margin-bottom:8px">
          <img src="${it.imageURL||''}" style="width:56px;height:56px;object-fit:cover;border-radius:6px" />
          <div style="flex:1">
            <div style="font-weight:600">${escapeHtml(it.name)}</div>
            <div style="font-size:0.85rem;color:#475569">$ ${Number(it.price).toFixed(2)} · ${it.qty} disponibles</div>
          </div>
          <div style="display:flex;gap:6px">
            <button data-id="${it.id}" data-action="edit" class="small">Editar</button>
            <button data-id="${it.id}" data-action="delete" class="small">Eliminar</button>
          </div>
        </div>
      `).join('');

      // attach events
      ownerProducts.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click',async e=>{
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          if(action==='edit'){
            const doc = await db.collection(PRODUCTS).doc(id).get();
            const d = doc.data();
            currentEditId = id;
            prodName.value = d.name;
            prodPrice.value = d.price;
            prodQty.value = d.qty;
            window.scrollTo({top:0,behavior:'smooth'});
          } else if(action==='delete'){
            if(!confirm('Eliminar este producto?')) return;
            const doc = await db.collection(PRODUCTS).doc(id).get();
            const d = doc.data();
            if(d.imagePath) await storage.ref(d.imagePath).delete().catch(()=>{});
            await db.collection(PRODUCTS).doc(id).delete();
          }
        })
      })
    }

    // ---------- guardar producto ----------
    saveProd.addEventListener('click', async ()=>{
      const name = prodName.value.trim();
      const price = parseFloat(prodPrice.value) || 0;
      const qty = parseInt(prodQty.value) || 0;
      if(!name){alert('Nombre requerido');return}

      saveProd.disabled = true; saveProd.textContent = 'Guardando...';
      try{
        let imageURL=null, imagePath=null;
        if(prodImage.files && prodImage.files[0]){
          const file = prodImage.files[0];
          const path = `products/${Date.now()}_${file.name}`;
          const ref = storage.ref(path);
          await ref.put(file);
          imageURL = await ref.getDownloadURL();
          imagePath = path;
        }

        if(currentEditId){
          const docRef = db.collection(PRODUCTS).doc(currentEditId);
          const old = (await docRef.get()).data() || {};
          // si se subió nueva imagen, borrar anterior
          if(imagePath && old.imagePath) await storage.ref(old.imagePath).delete().catch(()=>{});

          await docRef.update({name,price,qty, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), ...(imageURL?{imageURL,imagePath}:{})});
          currentEditId = null;
        } else {
          await db.collection(PRODUCTS).add({name,price,qty, imageURL, imagePath, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        }

        clearInputs();
      }catch(err){
        console.error(err); alert('Error al guardar: '+err.message);
      }finally{
        saveProd.disabled = false; saveProd.textContent = 'Guardar producto';
      }
    });

    clearForm.addEventListener('click', clearInputs);
    function clearInputs(){ prodName.value=''; prodPrice.value=''; prodQty.value=''; prodImage.value=''; currentEditId=null }

    // ---------- estilos ----------
    saveStyles.addEventListener('click', async ()=>{
      const bg = styleBg.value.trim();
      const accent = styleAccent.value.trim();
      const font = styleFont.value.trim();
      const size = parseInt(styleSize.value) || null;
      await db.collection(META_COLLECTION).doc(SETTINGS_DOC).set({bg,accent,font,size},{merge:true});
      alert('Estilos guardados.');
    });

    resetStyles.addEventListener('click', async ()=>{
      if(!confirm('Restablecer al valor por defecto?')) return;
      await db.collection(META_COLLECTION).doc(SETTINGS_DOC).set({bg:'',accent:'',font:'',size:''},{merge:true});
      alert('Restablecido.');
    });

    // ---------- login owner ----------
    loginOwner.addEventListener('click',async ()=>{
      const pass = ownerPass.value||'';
      if(!pass){alert('Ingresa la contraseña');return}
      loginOwner.disabled = true; loginOwner.textContent = 'Verificando...';
      try{
        const doc = await db.collection(META_COLLECTION).doc(SETTINGS_DOC).get();
        const data = doc.exists?doc.data():{};
        const hash = data.ownerPasswordHash || null;
        if(!hash){alert('No hay contraseña de dueño configurada. Configúrala en Firebase (ver instrucciones).');return}
        const h = await sha256(pass);
        if(h===hash){
          ownerLogged = true;
          ownerLocked.style.display='none';
          ownerPanel.style.display='block';
          logoutBtn.style.display='inline-block';
          ownerBtn.style.display='none';
          // cargar productos para edición ya ocurre por el realtime listener
          alert('Acceso concedido.');
        } else {
          alert('Contraseña incorrecta');
        }
      }catch(err){console.error(err);alert('Error al verificar');}
      finally{loginOwner.disabled=false; loginOwner.textContent='Entrar'}
    });

    logoutBtn.addEventListener('click', ()=>{
      ownerLogged=false;
      ownerLocked.style.display='block';
      ownerPanel.style.display='none';
      logoutBtn.style.display='none';
      ownerBtn.style.display='inline-block';
    })

    ownerBtn.addEventListener('click', ()=>{ ownerLocked.style.display='block'; ownerPanel.style.display='none'; ownerBtn.style.display='none'; })
    document.getElementById('cancelLogin').addEventListener('click', ()=>{ ownerBtn.style.display='inline-block'; ownerLocked.style.display='none' })

    // ---------- util ----------
    function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"]+/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s]||s)); }

    // ---------- inicializar ----------
    initRealtime();

    // ---------- instrucciones rapidas (console helpers) ----------
    // Para facilitar: en consola puedes ejecutar setOwnerPassword('miPass') para crear el hash en Firestore.
    window.setOwnerPassword = async function(pw){
      const h = await sha256(pw);
      await db.collection(META_COLLECTION).doc(SETTINGS_DOC).set({ownerPasswordHash:h},{merge:true});
      console.log('Hash guardado en Firestore (campo ownerPasswordHash)');
    }

    // Nota: antes de usar reemplaza firebaseConfig con tu configuración, habilita Firestore y Storage en tu proyecto, y ajusta reglas si es necesario.
  </script>
</body>
</html>
